<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Map with Rectangle Drawing</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <!-- Leaflet Drawing CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
        .coordinates-container {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .coordinate {
            font-family: monospace;
            background-color: #e9ecef;
            padding: 2px 5px;
            border-radius: 3px;
            margin: 2px;
        }
        .control-panel {
            margin: 10px 0;
        }
        button {
            padding: 8px 15px;
            margin: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Leaflet Map with Rectangle Drawing</h1>
    
    <div class="control-panel">
        <button id="drawBtn">Draw Rectangle</button>
        <button id="clearBtn">Clear Rectangle</button>
        <button id="deleteBtn" disabled>Delete Last Rectangle</button>
    </div>
    
    <div class="coordinates-container">
        <h3>Rectangle Corners:</h3>
        <div id="coordinates">
            <p>Draw a rectangle on the map to see coordinates</p>
        </div>
    </div>
    
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <!-- Leaflet Drawing JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <script>
        window.__gv__ = {
            GPS: null
        };
        
        window.GetNow = () => `${new Date(Date.now()+8*3600*1000).toISOString().replace('T', ' ').split('.')[0]}（香港時間）`;
        
        window.GetGPSLocation = () => {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation is not supported by this browser'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const response = {
                            coords: position.coords,
                            timestamp: `${new Date(position.timestamp + 8*3600*1000).toISOString().replace('T', ' ').split('.')[0]}（香港時間）`
                        };
						window.__gv__.GPS = response
                        // console.log('GPS Location:', window.__gv__.GPS);
                        resolve(response);
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                        // Default to Hong Kong Observatory coordinates if GPS fails
                        const fallbackPosition = {
                            coords: {
                                latitude: 22.3027,
                                longitude: 114.1772,
                                accuracy: 0
                            },
                            timestamp: window.GetNow()
                        };
                        window.__gv__.GPS = fallbackPosition;
                        resolve(fallbackPosition);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            });
        };

        // Initialize the application
        (async () => {
            try {
                await window.GetGPSLocation();
                
                // console.log('Initialized with:', window.__gv__);
                
                // Initialize the map with GPS location or fallback
                const initialLat = window.__gv__.GPS?.coords?.latitude || 22.3027;
                const initialLng = window.__gv__.GPS?.coords?.longitude || 114.1772;
                
                const map = L.map('map').setView([initialLat, initialLng], 18);
                
                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // Variables to store drawn rectangles
                let drawnRectangles = [];
                let drawControl;
                let currentDrawing = false;

                // Initialize the draw control
                function initDrawControl() {
                    drawControl = new L.Control.Draw({
                        draw: {
                            polygon: false,
                            polyline: false,
                            circle: false,
                            circlemarker: false,
                            marker: false,
                            rectangle: {
                                shapeOptions: {
                                    color: '#3388ff',
                                    weight: 2,
                                    fillColor: '#3388ff',
                                    fillOpacity: 0.2
                                }
                            }
                        },
                        edit: false
                    });
                }

                // Function to update coordinates display
                async function updateCoordinates(rectangle) {
                    const bounds = rectangle.getBounds();
                    const corners = {
                        NW: bounds.getNorthWest(), // Top-left
                        NE: bounds.getNorthEast(), // Top-right
                        SE: bounds.getSouthEast(), // Bottom-right
                        SW: bounds.getSouthWest()  // Bottom-left
                    };

                    const coordinatesDiv = document.getElementById('coordinates');
                    coordinatesDiv.innerHTML = `<p>更新時間：${window.__gv__.GPS?.timestamp || window.GetNow()}</p>`;

					const apiParams = {
						lat: {
							min: corners.SW.lat,
							max: corners.NE.lat,
						},
						lng: {
							min: corners.SW.lng,
							max: corners.NE.lng,
						}
					};
					const response = await fetch(`https://portal.csdi.gov.hk/server/services/common/fehd_rcd_1630036390312_58893/MapServer/WFSServer?service=wfs&request=GetFeature&typenames=FEHD_RL&outputFormat=geojson&maxFeatures=${100}&srsName=EPSG:4326&filter=<Filter><Intersects><PropertyName>SHAPE</PropertyName><gml:Envelope srsName='EPSG:4326'><gml:lowerCorner>${apiParams.lat.min} ${apiParams.lng.min}</gml:lowerCorner><gml:upperCorner>${apiParams.lat.max} ${apiParams.lng.max}</gml:upperCorner></gml:Envelope></Intersects></Filter>`);
					const jdata = await response.json();
					
					if (jdata && jdata.features) {
						// Clear existing markers first
						if (window.restaurantMarkers) {
							window.restaurantMarkers.forEach(marker => map.removeLayer(marker));
						}
						
						window.restaurantMarkers = [];
						
						jdata.features.forEach(feature => {
							const coords = feature.geometry.coordinates;
							const props = feature.properties;
							
							// Create marker
							const marker = L.marker([coords[1], coords[0]]);
							
							// Create popup content
							const popupContent = `
								<div style="max-width: 300px;">
									<h3>${props.NAME_EN || ''} / ${props.NAME_TC || ''}</h3>
									<p><strong>牌照類別：</strong> ${props.DATASET_EN || ''} / ${props.DATASET_TC || ''}</p>
									<p><strong>英文地址：</strong><br>
									${props.ADDRESS_EN || ''}<br>
									<p><strong>中文地址：</strong><br>
									${props.ADDRESS_TC || ''}</p>
									<p><strong>牌照到期日：</strong> ${props.NSEARCH05_EN || 'N/A'}</p>
									<br/>
									<p><strong>更新日期：</strong> ${props.LASTUPDATE || 'N/A'}</p>
								</div>
							`;
							
							marker.bindPopup(popupContent);
							marker.addTo(map);
							window.restaurantMarkers.push(marker);
							
							// Add click event to show popup
							marker.on('click', function() {
								this.openPopup();
							});
						});
						
						// If there are markers, fit the map bounds to show all markers along with the rectangle
						if (window.restaurantMarkers.length > 0) {
							const group = new L.featureGroup([...window.restaurantMarkers, rectangle]);
							map.fitBounds(group.getBounds().pad(0.1));
						}
					}
                }

                // Function to clear all rectangles
                function clearRectangles() {
                    drawnRectangles.forEach(rect => map.removeLayer(rect));
                    drawnRectangles = [];
                    document.getElementById('coordinates').innerHTML = '<p>Draw a rectangle on the map to see coordinates</p>';
                    document.getElementById('deleteBtn').disabled = true;
                }

                // Function to delete last rectangle
                async function deleteLastRectangle() {
                    if (drawnRectangles.length > 0) {
                        const lastRect = drawnRectangles.pop();
                        map.removeLayer(lastRect);
                        
                        if (drawnRectangles.length > 0) {
                            await updateCoordinates(drawnRectangles[drawnRectangles.length - 1]);
                        } else {
                            document.getElementById('coordinates').innerHTML = '<p>Draw a rectangle on the map to see coordinates</p>';
                            document.getElementById('deleteBtn').disabled = true;
                        }
                    }
                }

                // Event listeners for buttons
                document.getElementById('drawBtn').addEventListener('click', function() {
                    if (!currentDrawing) {
                        map.addControl(drawControl);
                        currentDrawing = true;
                        this.disabled = true;
                    }
                });

                document.getElementById('clearBtn').addEventListener('click', clearRectangles);
                document.getElementById('deleteBtn').addEventListener('click', deleteLastRectangle);

                // Handle rectangle creation
                map.on(L.Draw.Event.CREATED, async function(event) {
                    const layer = event.layer;
                    drawnRectangles.push(layer);
                    map.addLayer(layer);
                    
                    // Update coordinates display
                    await updateCoordinates(layer);
                    
                    // Remove draw control and re-enable draw button
                    map.removeControl(drawControl);
                    currentDrawing = false;
                    document.getElementById('drawBtn').disabled = false;
                    document.getElementById('deleteBtn').disabled = false;
                    
                    // Add click event to show coordinates when clicking on existing rectangle
                    layer.on('click', async function() {
                        await updateCoordinates(layer);
                    });
                });

                // Initialize draw control
                initDrawControl();

                // Add event to cancel drawing on map click when in drawing mode
                map.on('click', function() {
                    if (currentDrawing) {
                        map.removeControl(drawControl);
                        currentDrawing = false;
                        document.getElementById('drawBtn').disabled = false;
                    }
                });

            } catch (error) {
                console.error('Error initializing application:', error);
                // Fallback initialization if everything fails
                const map = L.map('map').setView([22.3027, 114.1772], 18);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                alert('應用程式初始化失敗，使用預設位置（香港天文台）');
            }
        })();
    </script>
</body>
</html>
